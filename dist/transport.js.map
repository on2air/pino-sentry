{"version":3,"file":"transport.js","sourceRoot":"","sources":["../src/transport.ts"],"names":[],"mappings":";;;;AACA,4DAA2B;AAC3B,wDAAwB;AACxB,gEAA+B;AAC/B,wDAAwB;AACxB,6DAAuC;AAEvC,MAAM,aAAc,SAAQ,KAAK;IAC/B,YAAmB,IAAS;QAC1B,KAAK,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;QAEpB,IAAI,CAAC,IAAI,GAAG,OAAO,CAAC;QACpB,IAAI,CAAC,KAAK,GAAG,IAAI,CAAC,KAAK,IAAI,IAAI,CAAC;IAClC,CAAC;CACF;AAED,SAAS,aAAa;IACpB,OAAO,kBAAO,CAAC,UAAS,KAAK,EAAE,IAAI,EAAE,EAAE;QACrC,IAAI,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;QACjB,OAAO,CAAC,MAAM,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC;QAC5B,EAAE,EAAE,CAAC;IACP,CAAC,CAAC,CAAC;AACL,CAAC;AAED,MAAM,cAAc,GAAG;IACrB,EAAE,EAAE,MAAM,CAAC,QAAQ,CAAC,KAAK;IACzB,EAAE,EAAE,MAAM,CAAC,QAAQ,CAAC,KAAK;IACzB,EAAE,EAAE,MAAM,CAAC,QAAQ,CAAC,IAAI;IACxB,EAAE,EAAE,MAAM,CAAC,QAAQ,CAAC,OAAO;IAC3B,EAAE,EAAE,MAAM,CAAC,QAAQ,CAAC,KAAK;IACzB,EAAE,EAAE,MAAM,CAAC,QAAQ,CAAC,KAAK;IACzB,6BAA6B;IAC7B,gFAAgF;IAChF,KAAK,EAAE,MAAM,CAAC,QAAQ,CAAC,KAAK;IAC5B,KAAK,EAAE,MAAM,CAAC,QAAQ,CAAC,KAAK;IAC5B,IAAI,EAAE,MAAM,CAAC,QAAQ,CAAC,IAAI;IAC1B,OAAO,EAAE,MAAM,CAAC,QAAQ,CAAC,OAAO;IAChC,KAAK,EAAE,MAAM,CAAC,QAAQ,CAAC,KAAK;IAC5B,KAAK,EAAE,MAAM,CAAC,QAAQ,CAAC,KAAK;CACpB,CAAC;AAGX,MAAa,mBAAmB;IAC9B,YAAmB,OAA4B;QAC7C,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,YAAY,CAAC,OAAO,IAAI,EAAE,CAAC,CAAC,CAAC;IAChD,CAAC;IAEM,cAAc,CAAC,KAAkC;QACtD,OAAO,cAAc,CAAC,KAAK,CAAC,IAAI,MAAM,CAAC,QAAQ,CAAC,IAAI,CAAC;IACvD,CAAC;IAED,IAAW,MAAM;QACf,OAAO,MAAM,CAAC;IAChB,CAAC;IAEM,KAAK,CAAC,IAAS;QACpB,MAAM,KAAK,GAAG,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC;QAC/B,MAAM,EAAE,GAAG,GAAG,EAAE;QAChB,CAAC,CAAC;QAEF,IAAI,CAAC,YAAY,CAAC,KAAK,EAAE,EAAE,CAAC,CAAC;IAC/B,CAAC;IAEM,WAAW;QAChB,OAAO,kBAAO,CAAC,GAAG,CAAC,CAAC,KAAU,EAAE,IAAS,EAAE,EAAO,EAAE,EAAE;YACpD,IAAI,CAAC,YAAY,CAAC,KAAK,EAAE,EAAE,CAAC,CAAC;QAC/B,CAAC,CAAC,CAAC;IACL,CAAC;IAEM,YAAY,CAAC,KAAU,EAAE,EAAO;QACrC,MAAM,QAAQ,GAAG,IAAI,CAAC,cAAc,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC;QAClD,MAAM,IAAI,GAAG,KAAK,CAAC,IAAI,IAAI,EAAE,CAAC;QAE9B,IAAI,KAAK,CAAC,KAAK,EAAE;YACf,IAAI,CAAC,IAAI,GAAG,KAAK,CAAC,KAAK,CAAC;SACzB;QAED,IAAI,KAAK,CAAC,YAAY,EAAE;YACtB,IAAI,CAAC,YAAY,GAAG,KAAK,CAAC,YAAY,CAAC;SACxC;QAED,IAAI,KAAK,CAAC,QAAQ,EAAE;YAClB,IAAI,CAAC,QAAQ,GAAG,KAAK,CAAC,QAAQ,CAAC;SAChC;QAED,iCAAiC;QAEjC,MAAM,OAAO,GAAG,KAAK,CAAC,GAAG,CAAC;QAC1B,MAAM,KAAK,GAAG,KAAK,CAAC,KAAK,IAAI,EAAE,CAAC;QAEhC,MAAM,CAAC,SAAS,CAAC,KAAK,CAAC,EAAE;YACvB,IAAG,KAAK,CAAC,IAAI;gBAAC,KAAK,CAAC,OAAO,CAAC,KAAK,CAAC,IAAI,CAAC,CAAA;YACvC,IAAI,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,EAAE;gBACvB,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,OAAO,CAAC,GAAG,CAAC,EAAE,CAAC,KAAK,CAAC,QAAQ,CAAC,GAAG,EAAE,IAAI,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC;aAClE;QACH,CAAC,CAAC,CAAC;QAEH,gCAAgC;QAChC,IAAI,IAAI,CAAC,kBAAkB,CAAC,QAAQ,CAAC,EAAE;YACrC,MAAM,KAAK,GAAG,OAAO,YAAY,KAAK,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,IAAI,aAAa,CAAC,EAAE,OAAO,EAAE,KAAK,EAAE,CAAC,CAAC;YAEzF,YAAY,CAAC,GAAG,EAAE;gBAChB,MAAM,CAAC,gBAAgB,CAAC,KAAK,CAAC,CAAC;gBAC/B,EAAE,EAAE,CAAC;YACP,CAAC,CAAC,CAAC;SACJ;aAAM;YACL,wBAAwB;YACxB,uBAAuB;YACvB,8CAA8C;YAC9C,UAAU;YACV,MAAM;SACP;IACH,CAAC;IAEO,YAAY,CAAC,UAA8B,EAAE;QACnD,OAAO;YACL,GAAG,EAAE,OAAO,CAAC,GAAG,CAAC,UAAU,IAAI,EAAE;YACjC,iDAAiD;YACjD,yCAAyC;YACzC,UAAU,EAAE,OAAO,CAAC,GAAG,CAAC,gBAAgB,IAAI,aAAa;YACzD,WAAW,EAAE,OAAO,CAAC,GAAG,CAAC,kBAAkB,IAAI,OAAO,CAAC,GAAG,CAAC,QAAQ,IAAI,YAAY;YACnF,KAAK,EAAE,CAAC,CAAC,OAAO,CAAC,GAAG,CAAC,YAAY,IAAI,KAAK;YAC1C,UAAU,EAAE,GAAG;YACf,cAAc,EAAE,GAAG;YACnB,GAAG,OAAO;SACX,CAAC;IACJ,CAAC;IAEO,QAAQ,CAAC,GAAQ;QACvB,MAAM,IAAI,GAAG,OAAO,GAAG,CAAC;QACxB,OAAO,IAAI,KAAK,UAAU,IAAI,IAAI,KAAK,QAAQ,IAAI,CAAC,CAAC,GAAG,CAAC;IAC3D,CAAC;IAEO,kBAAkB,CAAC,KAAsB;QAC/C,OAAO,KAAK,KAAK,MAAM,CAAC,QAAQ,CAAC,KAAK,IAAI,KAAK,KAAK,MAAM,CAAC,QAAQ,CAAC,KAAK,CAAC;IAC5E,CAAC;CACF;AA9FD,kDA8FC;AAAA,CAAC;AAEF,SAAgB,sBAAsB,CAAC,UAA8B,EAAE;IACrE,IAAI,CAAC,OAAO,CAAC,GAAG,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,UAAU,EAAE;QAC3C,MAAM,KAAK,CAAC,oBAAoB,CAAC,CAAC;KACnC;IAED,MAAM,SAAS,GAAG,IAAI,mBAAmB,CAAC,OAAO,CAAC,CAAC;IACnD,MAAM,iBAAiB,GAAG,SAAS,CAAC,WAAW,EAAE,CAAC;IAElD,MAAM,SAAS,GAAG,cAAI,CAAC,cAAI,CAAC,CAAC;IAC7B,OAAO,SAAS,CACd,OAAO,CAAC,KAAK,CAAC,IAAI,CAAC,aAAa,EAAE,CAAC,EACnC,gBAAK,CAAC,CAAC,IAAI,EAAE,EAAE;QACb,IAAI;YACF,OAAO,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC;SACzB;QAAC,OAAO,CAAC,EAAE;YACV,MAAM,KAAK,CAAC,+BAA+B,CAAC,CAAC;SAC9C;IACH,CAAC,CAAC,EACF,iBAAiB,CAClB,CAAC;AACJ,CAAC;AApBD,wDAoBC;AAAA,CAAC;AAGF,SAAgB,iBAAiB,CAAC,UAA8B,EAAE;IAChE,IAAI,CAAC,OAAO,CAAC,GAAG,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,UAAU,EAAE;QAC3C,MAAM,KAAK,CAAC,oBAAoB,CAAC,CAAC;KACnC;IAED,MAAM,SAAS,GAAG,IAAI,mBAAmB,CAAC,OAAO,CAAC,CAAC;IACnD,MAAM,WAAW,GAAG,SAAS,CAAC,KAAK,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC;IAEpD,OAAO,MAAM,CAAC,MAAM,CAAC,gBAAK,CAAC,WAAW,CAAC,EAAE,EAAE,SAAS,EAAE,CAAC,CAAC;AAC1D,CAAC;AATD,8CASC;AAAA,CAAC","sourcesContent":["import stream  from 'stream';\nimport split from 'split2';\nimport pump from 'pump';\nimport through from 'through2';\nimport pify from 'pify';\nimport * as Sentry from '@sentry/node';\n\nclass ExtendedError extends Error {\n  public constructor(info: any) {\n    super(info.message);\n\n    this.name = \"Error\";\n    this.stack = info.stack || null;\n  }\n}\n\nfunction writeToStdout() {\n  return through(function(chunk, _enc, cb) {\n    this.push(chunk);\n    process.stdout.write(chunk);\n    cb();\n  });\n}\n\nconst SEVERITIES_MAP = {\n  10: Sentry.Severity.Debug,   // pino: trace\n  20: Sentry.Severity.Debug,   // pino: debug\n  30: Sentry.Severity.Info,    // pino: info\n  40: Sentry.Severity.Warning, // pino: warn\n  50: Sentry.Severity.Error,   // pino: error\n  60: Sentry.Severity.Fatal,   // pino: fatal\n  // Support for useLevelLabels\n  // https://github.com/pinojs/pino/blob/master/docs/api.md#uselevellabels-boolean\n  trace: Sentry.Severity.Debug,\n  debug: Sentry.Severity.Debug,\n  info: Sentry.Severity.Info,\n  warning: Sentry.Severity.Warning,\n  error: Sentry.Severity.Error,\n  fatal: Sentry.Severity.Fatal,\n} as const;\n\n\nexport class PinoSentryTransport {\n  public constructor(options?: Sentry.NodeOptions) {\n    Sentry.init(this.withDefaults(options || {}));\n  }\n\n  public getLogSeverity(level: keyof typeof SEVERITIES_MAP): Sentry.Severity {\n    return SEVERITIES_MAP[level] || Sentry.Severity.Info;\n  }\n\n  public get sentry() {\n    return Sentry;\n  }\n\n  public parse(line: any) {\n    const chunk = JSON.parse(line);\n    const cb = () => {\n    };\n\n    this.prepareAndGo(chunk, cb);\n  }\n\n  public transformer(): stream.Transform {\n    return through.obj((chunk: any, _enc: any, cb: any) => {\n      this.prepareAndGo(chunk, cb);\n    });\n  }\n\n  public prepareAndGo(chunk: any, cb: any): void {\n    const severity = this.getLogSeverity(chunk.level);\n    const tags = chunk.tags || {};\n\n    if (chunk.reqId) {\n      tags.uuid = chunk.reqId;\n    }\n\n    if (chunk.responseTime) {\n      tags.responseTime = chunk.responseTime;\n    }\n\n    if (chunk.hostname) {\n      tags.hostname = chunk.hostname;\n    }\n\n    // const user = chunk.user || {};\n\n    const message = chunk.msg;\n    const stack = chunk.stack || '';\n\n    Sentry.withScope(scope => {\n      if(chunk.user)scope.setUser(chunk.user)\n      if (this.isObject(tags)) {\n        Object.keys(tags).forEach(tag => scope.setExtra(tag, tags[tag]));\n      }\n    });\n\n    // Capturing Errors / Exceptions\n    if (this.shouldLogException(severity)) {\n      const error = message instanceof Error ? message : new ExtendedError({ message, stack });\n\n      setImmediate(() => {\n        Sentry.captureException(error);\n        cb();\n      });\n    } else {\n      // // Capturing Messages\n      // setImmediate(() => {\n      //   Sentry.captureMessage(message, severity);\n      //   cb();\n      // });\n    }\n  }\n\n  private withDefaults(options: Sentry.NodeOptions = {}): Sentry.NodeOptions {\n    return {\n      dsn: process.env.SENTRY_DSN || '',\n      // npm_package_name will be available if ran with\n      // from a \"script\" field in package.json.\n      serverName: process.env.npm_package_name || 'pino-sentry',\n      environment: process.env.SENTRY_ENVIRONMENT || process.env.NODE_ENV || 'production',\n      debug: !!process.env.SENTRY_DEBUG || false,\n      sampleRate: 1.0,\n      maxBreadcrumbs: 100,\n      ...options,\n    };\n  }\n\n  private isObject(obj: any): boolean {\n    const type = typeof obj;\n    return type === 'function' || type === 'object' && !!obj;\n  }\n\n  private shouldLogException(level: Sentry.Severity): boolean {\n    return level === Sentry.Severity.Fatal || level === Sentry.Severity.Error;\n  }\n};\n\nexport function createWriteStreamAsync(options: Sentry.NodeOptions = {}): PromiseLike<stream.Transform> {\n  if (!options.dsn && !process.env.SENTRY_DSN) {\n    throw Error('Sentry DSN missing');\n  }\n\n  const transport = new PinoSentryTransport(options);\n  const sentryTransformer = transport.transformer();\n\n  const pumpAsync = pify(pump);\n  return pumpAsync(\n    process.stdin.pipe(writeToStdout()),\n    split((line) => {\n      try {\n        return JSON.parse(line);\n      } catch (e) {\n        throw Error('logs should be in json format');\n      }\n    }),\n    sentryTransformer\n  );\n};\n\n\nexport function createWriteStream(options: Sentry.NodeOptions = {}): stream.Transform & { transport: PinoSentryTransport } {\n  if (!options.dsn && !process.env.SENTRY_DSN) {\n    throw Error('Sentry DSN missing');\n  }\n\n  const transport = new PinoSentryTransport(options);\n  const sentryParse = transport.parse.bind(transport);\n\n  return Object.assign(split(sentryParse), { transport });\n};\n"]}